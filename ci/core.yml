image: registry.corp.sldev.cz/trezor/trezor-firmware/environment

variables:
  SDL_VIDEODRIVER: "dummy"
  XDG_RUNTIME_DIR: "/var/tmp"

build core firmware:
  stage: build
  script:
    - cd core
    - pipenv run make build_cross
    - pipenv run make build_boardloader
    - pipenv run make build_bootloader
    - pipenv run make build_prodtest
    - pipenv run make build_firmware
    # - test "$TREZOR_MODEL" = "1" || pipenv run make sizecheck
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    paths:
    - core/build/firmware/firmware.bin
    - core/build/bootloader/bootloader.bin
    expire_in: 1 week

build core unix:
  stage: build
  script:
    - cd core
    - pipenv run make build_unix

build core unix frozen:
  stage: build
  script:
    - cd core
    - pipenv run make build_unix_frozen
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
    untracked: true
    expire_in: 1 day

# test core unix unit:
#   stage: test
#   dependencies:
#     - build core unix frozen
#   script:
#     - cd core
#     - pipenv run make test

# test core unix device:
#   stage: test
#   dependencies:
#     - build core unix frozen
#   script:
#     - cd core
#     - pipenv run make test_emu

# test core unix monero:
#   stage: test
#   dependencies:
#     - build core unix frozen
#   script:
#     - cd core
#     - pipenv run make test_emu_monero

aftertest upload core unix:
  stage: aftertest
  variables:
    DEPLOY_DIRECTORY: ${DEPLOY_BASE_DIR}/core/emulators/
    DEPLOY_PATH: ${DEPLOY_BASE_DIR}/core/emulators/${CI_COMMIT_REF_NAME}/${date -I}-core-emu-${CI_COMMIT_SHORT_SHA}
  when: manual
  dependencies:
    - build core unix frozen
  script:
    - echo "Deploying to server"
    - echo ${DEPLOY_DIRECTORY}
    - echo ${DEPLOY_PATH}
    - mkdir -p ${DEPLOY_DIRECTORY}/${CI_COMMIT_REF_NAME}
    - rsync --delete -va build/unix/micropython "${DEPLOY_PATH}"
  tags:
    - deploy
